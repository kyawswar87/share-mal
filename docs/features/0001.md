# Feature 0001: Bill Creation Endpoints

## Brief Description

Implement REST API endpoints for bill creation functionality in the shalmal_v2 project. This feature will provide endpoints to create bills with individual line items, allowing users to split expenses among multiple people based on a total bill amount.

## Technical Requirements

Based on the existing shalmal project structure and the shalmal_v2 API patterns, implement the following bill creation endpoints:

### Endpoints to Implement

1. **POST /api/v1/bills** - Create a new bill
2. **GET /api/v1/bills/{id}** - Get bill by ID  
3. **GET /api/v1/bills** - Get all bills (with optional filtering)
4. **PUT /api/v1/bills/{id}** - Update an existing bill
5. **DELETE /api/v1/bills/{id}** - Delete a bill

## Files and Functions to Create/Modify

### New Files to Create

#### Entity Layer
- `src/main/java/com/shalmal/shalmal_v2/model/Bill.java` - Bill entity with JPA annotations
- `src/main/java/com/shalmal/shalmal_v2/model/Person.java` - Person entity for bill participants
- `src/main/java/com/shalmal/shalmal_v2/enums/OperatorType.java` - Enum for bill splitting operators
- `src/main/java/com/shalmal/shalmal_v2/enums/BillStatus.java` - Enum for bill status
- `src/main/java/com/shalmal/shalmal_v2/enums/PaymentStatus.java` - Enum for payment status

#### DTO Layer  
- `src/main/java/com/shalmal/shalmal_v2/dto/BillDto.java` - Bill data transfer object
- `src/main/java/com/shalmal/shalmal_v2/dto/PersonDto.java` - Person data transfer object
- `src/main/java/com/shalmal/shalmal_v2/dto/BillCreateRequest.java` - Request DTO for bill creation
- `src/main/java/com/shalmal/shalmal_v2/dto/BillUpdateRequest.java` - Request DTO for bill updates

#### Repository Layer
- `src/main/java/com/shalmal/shalmal_v2/repository/BillRepository.java` - JPA repository for Bill entity
- `src/main/java/com/shalmal/shalmal_v2/repository/PersonRepository.java` - JPA repository for Person entity

#### Service Layer
- `src/main/java/com/shalmal/shalmal_v2/service/BillService.java` - Business logic for bill operations
- `src/main/java/com/shalmal/shalmal_v2/service/PersonService.java` - Business logic for person operations

#### Controller Layer
- `src/main/java/com/shalmal/shalmal_v2/controller/BillController.java` - REST controller for bill endpoints

#### Test Files
- `src/test/java/com/shalmal/shalmal_v2/service/BillServiceTest.java` - Unit tests for BillService
- `src/test/java/com/shalmal/shalmal_v2/controller/BillControllerTest.java` - Unit tests for BillController
- `src/test/java/com/shalmal/shalmal_v2/repository/BillRepositoryTest.java` - Repository tests

### Files to Modify

#### Configuration
- `src/main/resources/application.properties` - Add database configuration for bill-related tables

## Implementation Algorithm

### Phase 1: Data Layer Foundation
1. **Create Enums** - Define OperatorType (EQUALLY, CUSTOM), BillStatus (INCOMPLETE, COMPLETE, PAID), PaymentStatus (PAID, UNPAID)
2. **Create Entities** - Implement Bill and Person entities with proper JPA relationships:
   - Bill entity with fields: id, title, totalAmount, operator, billDate, status, createdDate, persons (OneToMany)
   - Person entity with fields: id, name, amount, paymentStatus, bill (ManyToOne)
3. **Create Repositories** - Extend JpaRepository with custom query methods for filtering and searching
4. **Database Schema** - Tables will be auto-generated: `bills`, `persons`, `bill_persons` (join table)

### Phase 2: Service Layer Implementation  
1. **BillService Methods**:
   - `createBill(BillCreateRequest request)` - Create bill with persons and handle equal distribution
   - `getBillById(Long id)` - Retrieve bill with persons
   - `getAllBills()` - Get all bills with optional filtering
   - `updateBill(Long id, BillUpdateRequest request)` - Update bill details
   - `deleteBill(Long id)` - Delete bill and associated persons
   - `distributeAmountEqually(Bill bill, List<Person> persons)` - Private method for equal distribution

2. **PersonService Methods**:
   - `createPerson(PersonDto personDto)` - Create person entity
   - `updatePersonPaymentStatus(Long personId, PaymentStatus status)` - Update payment status
   - `getPersonsByBillId(Long billId)` - Get all persons for a bill

### Phase 3: Controller Layer Implementation
1. **BillController Endpoints**:
   - `POST /api/v1/bills` - Create bill endpoint using BillCreateRequest
   - `GET /api/v1/bills/{id}` - Get bill by ID with ApiResponse wrapper
   - `GET /api/v1/bills` - Get all bills with optional query parameters for filtering
   - `PUT /api/v1/bills/{id}` - Update bill endpoint using BillUpdateRequest  
   - `DELETE /api/v1/bills/{id}` - Delete bill endpoint

2. **Response Format** - Follow existing ApiResponse<T> pattern from UserController
3. **Error Handling** - Use existing GlobalExceptionHandler for consistent error responses
4. **Validation** - Use @Valid annotations and existing validation patterns
5. **Documentation** - Add OpenAPI annotations following existing UserController patterns

### Phase 4: Testing Implementation
1. **Unit Tests** - Test all service methods with Mockito
2. **Controller Tests** - Test all endpoints with @WebMvcTest
3. **Repository Tests** - Test custom query methods with @DataJpaTest
4. **Integration Tests** - Test complete request/response cycles

## Key Implementation Details

### Bill Creation Logic
1. Validate input data (title, totalAmount, operator, billDate, persons)
2. Create Bill entity with INCOMPLETE status by default
3. Create Person entities for each participant
4. If operator is EQUALLY, distribute totalAmount equally among persons
5. If operator is CUSTOM, use provided amounts for each person
6. Save bill and persons with proper relationships
7. Return created bill with all persons included

### Equal Distribution Algorithm
1. Calculate amount per person: `totalAmount / numberOfPersons`
2. Distribute equal amounts to all persons except the last one
3. Calculate remaining amount: `totalAmount - (amountPerPerson * (numberOfPersons - 1))`
4. Assign remaining amount to the last person to handle rounding differences

### API Response Format
All endpoints will return responses wrapped in ApiResponse<T> format:
```json
{
  "data": { /* bill or list of bills */ },
  "message": "Success message",
  "status": "SUCCESS",
  "timestamp": "2024-01-01T12:00:00Z"
}
```

### Error Handling
- Use existing ResourceNotFoundException for 404 responses
- Use existing ValidationException for 400 responses  
- Use existing GlobalExceptionHandler for consistent error formatting
- Return appropriate HTTP status codes (201 for creation, 200 for success, 404 for not found, 400 for validation errors)

## Dependencies and Configuration

### Database Configuration
- Add JPA configuration for bill-related entities
- Configure Hibernate to auto-generate tables
- Set up proper relationship mappings between Bill and Person entities

### Validation Rules
- Bill title: required, 1-255 characters
- Total amount: required, greater than 0
- Operator: required, must be EQUALLY or CUSTOM
- Bill date: required, valid date
- Person name: required, 1-100 characters
- Person amount: required, greater than 0 (for CUSTOM operator)

This implementation will provide a complete bill creation system that follows the existing project patterns and integrates seamlessly with the current shalmal_v2 architecture.
